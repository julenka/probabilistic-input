<!DOCTYPE html>
<html>
<head>
    <title>Reduction</title>
    <!-- JQuery -->
    <script type="text/javascript" src="../lib/jquery.js"></script>
    <script type="text/javascript" src="../lib/snap.svg.js"></script>

    <script type="text/javascript" src="../julia.js"></script>
    <link type="text/css" rel="stylesheet" href="../julia.css"/>
</head>
<body>
<h3> History Cursor </h3>
<div id="top_bar"></div>
<div id="demo_description">
    More of a paintbrush than a cursor. Try dragging to see for yourself.
</div>
<div>
    <div>
        <label for="numSamples">number of event samples:</label>
        <input type="text" id="numSamples" value="10"/>
    </div>
    <div>
        <label for="numAlternatives">number of alternatives to keep:</label>
        <input type="text" id="numAlternatives" value ="50"/>
    </div>
    <div>
        <label for="sampleVarianceX">sample x variance:</label>
        <input type="text" id="sampleVarianceX" value="10"/>
    </div>
    <div>
        <label for="sampleVarianceY">sample y variance:</label>
        <input type="text" id="sampleVarianceY" value="10"/>
    </div>
    <div>
        <label for="circleRadius">circle radius:</label>
        <input type="text" id="circleRadius" value="50"/>
    </div>
    <div>
        <label for="draw_history">paintbrush mode</label>
        <input type="checkbox" id="draw_history" checked="true">
    </div>
    <button onclick="update()">Update Settings</button>

</div>
<div id="demo_settings"></div>
<table>
    <tr>
        <td>
            <svg class="border1px unselectable" id="sketch" width="500" height="300"></svg>
        </td>
        <td>
            <div id="sketches"></div>
        </td>

    </tr>
</table>

<script type="text/javascript">

    var HistoryCursor = Cursor.subClass({
        className: "HistoryCursor",
        init: function(julia, properties) {
            this._super(julia, properties);
            this.path = [];
        },
        clone: function() {
            var clone = this._super();
            clone.path = [];
            clone.path.extend(this.path);
            clone.draw_history = this.draw_history;
            return clone;
        },
        drag_progress: function(e) {
            this._super(e);
            if(this.draw_history) {
                this.path.push(this.properties.x + ", " + this.properties.y);
            }
        },
        drag_end: function(e) {
            this._super(e);
            this.path = [];
        },
        draw: function ($el) {
            this._super($el);
            // TODO are we okay with drawing this to a Snap?
            // in this case $el will be an SVG element
            var s = Snap($el[0]);
            if (this.path.length > 1) {
                s.path("M" + this.path.join("L")).attr({stroke: this.properties.color, fill: "none",
                    "stroke-width": this.properties.radius, opacity: this.properties.opacity});
            }
        }
    });

    var julia = new Julia();
    var rootView = new ContainerView(julia);
    var view = new Cursor(julia);
    rootView.addChildView(view);
    julia.setRootView(rootView);

    var txtXVariance = $("#sampleVarianceX");
    var txtYVariance = $("#sampleVarianceY");
    var txtNumSamples = $("#numSamples");
    var txtNumAlternatives = $("#numAlternatives");
    var txtCursorRadius = $("#circleRadius");
    var chkDrawHistory = $("#draw_history");
    var $sketch = $("#sketch");
    var $sketches = $("#sketches");


    /**
     *
     * attributes: name, id, checked
     * description: description of the option (user sees this)
     * onClick: execute when clicked
     */
    function addOption(attributes, description, onClick) {
        var option = $("<input/>")
                .attr("type", "radio")
                .attr(attributes)
                .click(onClick);
        var label = $("<label/>")
                .attr("for", attributes.id)
                .html(description);
        $("#demo_settings").append(option, label);
    }

    var onOptionClicked = function(feedbackFn) {
        return function(e) {
            var $this = $(this);
            julia.feedback = feedbackFn();
        }
    };

    addOption({name: "feedback_options", id:"n_best_1", checked: true},
            "overlay with opacity",
            onOptionClicked(function() { return new OverlayFeedback(julia)})
    );
    addOption({name: "feedback_options", id:"n_best_2", checked: false},
            "show mean interface",
            onOptionClicked(function() { return new MeanFeedback (julia) })
    );

    julia.dispatchCompleted = function(new_alternatives, uiUpdated) {
        if(!uiUpdated) {
            return;
        }
        $sketch.empty();
        julia.drawFeedback($sketch, new OverlayFeedback(julia));
        julia.drawFeedback($sketch,julia.feedback);
        julia.dumpAlternativesAsSnap($sketches, $sketch.width(), $sketch.height(), 0.25);
    };
    var mouseHook = new PMouseEventHook($sketch[0]);
    julia.addEventSource(mouseHook);

    function update() {
        julia.nSamplesPerEvent = parseInt(txtNumSamples.val());
        julia.nAlternativesToKeep = parseInt(txtNumAlternatives.val());
        mouseHook.variance_x_px = parseInt(txtXVariance.val());
        mouseHook.variance_y_px = parseInt(txtYVariance.val());
        view.radius = parseInt(txtCursorRadius.val());
        view.draw_history = chkDrawHistory.prop('checked');
        julia.setRootView(rootView);
    }
    update();
    julia.feedback = new OverlayFeedback(julia);


</script>
</body>
</html>