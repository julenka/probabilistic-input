<!DOCTYPE html>

<html>
<head>
    <title>Focus-Free Text Entry</title>
    <!-- JQuery -->
    <script type="text/javascript" src="../lib/jquery.js"></script>
    <script type="text/javascript" src="../lib/snap.svg.js"></script>

    <script type="text/javascript" src="../julia.js"></script>
    <script type="text/javascript" src="../views/form_entry.js"></script>
    <link rel="stylesheet" type="text/css" href="../julia.css"/>
    <style>
        div {
            margin: 5px;
        }

    </style>
</head>
<body>
<div id="top_bar"></div>
<h3>Focus-Free Text Entry</h3>
<div id="demo_description">
    A form which does not require focus. Type in text, no need to specify which field. The program will figure it out.
    NOTE: To delete, press 'x', not backspace (sorry, that doesn't work for now)
    <div>voice status:</div>
    <div id="status"></div>
</div>

<div id="demo_settings">
    <div class="float-left">
        <h3>Feedback</h3>
        <div>
            <input id="feedback_regular" name="feedback" type="radio" checked="true"/>
            <label for="feedback_regular">regular</label>
        </div>
        <div>
            <input id="feedback_jitter1" name="feedback" type="radio" />
            <label for="feedback_jitter1">jitter 1</label>
        </div>
        <div>
            <input id="feedback_jitter2" name="feedback" type="radio" />
            <label for="feedback_jitter2">jitter 2</label>
        </div>
        <div>
            <input id="feedback_pulse" name="feedback" type="radio" />
            <label for="feedback_pulse">pulse</label>
        </div>
    </div>


    <div class="float-left">
        <h3>Debug Info</h3>
        <div>

            <input id="dbg_dumptext" type="checkbox" />
            <label for="dbg_dumptext">dump alternatives as text</label>
        </div>

        <div>
            <input id="dbg_dumpsnap" type="checkbox" checked="true"/>
            <label for="dbg_dumpsnap">dump alternative renderings</label>

        </div>
    </div>
    <div class="float-left">
        <h3>Input Source</h3>
        Keyboard type:
        <div>
            <input id="key_regular" name="keyboard" type="radio" checked="true"/>
            <label for="key_regular">regular</label>
        </div>
        <div>
            <input id="key_cap" name="keyboard" type="radio" />
            <label for="key_cap">capitalize first letter</label>
        </div>
        <input type="button" id="start_speech" value="start speech"/>
        <input type="button" id="stop_speech" value="stop speech"/>
        <input type="button" id="reset_button" value="reset"/>
    </div>

</div>

<div class="float-clear">
    <table>
        <tr>
            <td>
                <svg id="demo_interface" class="border1px" width="500" height="400"></svg>
            </td>
            <td>
                <div id="demo_alternatives"></div>
            </td>
        </tr>
    </table>
    <div id="debug"></div>

</div>

<script>
</script>

<script>

var $sketch = $("#demo_interface");
var $sketches = $("#demo_alternatives");
var $state = $("#status");



$("#dbg_dumptext").click(function(){
    $("#debug").empty();
});
$("#dbg_dumpsnap").click(function(){
    $("#demo_alternatives").empty();
});

$("#reset_button").click(function(){
    reset();
});

function makeVoiceEventSource() {
    var source = new PVoiceEventSource();
    source.onerror = function(event) {
        if (event.error == 'no-speech') {
            $state.html("No speech was detected. You may need to adjust your microphone settings");
        }
        if (event.error == 'audio-capture') {
            $state.html("No microphone installed");
        }
        if (event.error == 'not-allowed') {
            $state.html("Click the 'Allow' button above to enable your microphone");
        }
    };
    source.onend = function() {
        $state.html("speech ended");
    };
    source.onstart = function() {
        $state.html("speech started. Speak into microphone.");
    };
    source.onend = function() {
        $state.html("speech stopped.");
    };
    return source;
}

function reset() {
    var rootView = new ContainerView(julia);
    julia.setRootView(rootView);

    var labelx = 50;
    var starty = 50;
    var dy = 50;
    var fields = [];
    fields.push(new FormEntry(julia, "name (last, first)", function(input) { return /[a-zA-z, ]+/.test(input);},
            function(current_text) { return /^\s*\w+\s*,\s*\w+\s*$/.test(current_text)},
            labelx, starty
    ));
    starty += dy;

    fields.push(new FormEntry(julia, "dob (mm/dd/yyyy)", function(input) { return /[0-9\/x ]+/.test(input);},
            function(current_text) { return /^[ ]*\d{2}[ ]*\/[ ]*\d{2}[ ]*\/[ ]*\d{4}[ ]*$/.test(current_text)},
            labelx, starty
    ));
    starty += dy;

    fields.push(new FormEntry(julia, "email", function(input) { return /[a-z0-9@\.]+/.test(input);},
            function(currentText) { return /^[a-z0-9]+@\w+\.[a-z]+$/.test(currentText); }, labelx, starty)); // (julia, label, validFunction, x, y) {)
    starty += dy;


    fields.push(new FormEntry(julia, "ssn", function(input) { return /[x\d]+/.test(input) && /^\d{0,8}$/.test(this.entry_text); },
            function(current_text) { return /^\d{9}$/.test(current_text)}, labelx, starty));
    starty += dy;
    fields.push(new FormEntry(julia, "phone", function(input) { return /[x\d]+/.test(input) && /^\d{0,9}$/.test(this.entry_text); },
            function(current_text) { return /^(\d{10}|\d{7})$/.test(current_text)}, labelx, starty));
    starty += dy;
    fields.push(new FormEntry(julia, "favorite fruit", function(input) { return /[a-z]+/.test(input); },
            function(current_text) { return /^(apple|orange|banana)$/.test(current_text)}, labelx, starty));

    starty += dy;
    fields.push(new FormEntry(julia, "favorite color", function(input) { return /[a-z]+/.test(input); },
            function(current_text) { return /^(red|yellow|blue|orange)$/.test(current_text)}, labelx, starty));

    fields.forEach(function(f){
        rootView.addChildView(f);
    });
//    var cursor = new Cursor(julia);
//    rootView.addChildView(cursor);
    $sketch.empty();
    $("#debug").empty();
    $("#alternative_interfaces").empty();
    rootView.draw($sketch);
}

var julia = new Julia();
var feedback = new OverlayFeedback(julia, {feedbackType: OverlayUnmodified});
julia.nSamplesPerEvent = 1;

$("#feedback_regular").click(function(){
     feedback = new OverlayFeedback(julia, {feedbackType: OverlayUnmodified});
});
$("#feedback_jitter1").click(function(){
    feedback = new AnimateFeedback(julia, {feedbackType: AnimateJitterRotate});
});
$("#feedback_jitter2").click(function(){
    feedback = new AnimateFeedback(julia, {feedbackType: AnimateJitterTranslate});
});
$("#feedback_pulse").click(function(){
    feedback = new AnimateFeedback(julia, {feedbackType: AnimateJitterScale});
});
$("#key_regular").click(function(){
    julia.removeEventSource(p_cap_key_hook);
    julia.addEventSource(p_key_hook);
});
$("#key_cap").click(function(){
    julia.removeEventSource(p_key_hook);
    julia.addEventSource(p_cap_key_hook);
});

julia.dispatchCompleted = function(new_alternatives, uiUpdated) {
    if(!uiUpdated) {
        return;
    }

    $sketch.empty();
    var merged = julia.drawFeedback($sketch, feedback);


    if($("#dbg_dumptext").is(':checked')) {
        merged.domDump($("#debug"));
    }

    if($("#dbg_dumpsnap").is(':checked')) {
        julia.dumpAlternativesAsSnap($sketches, $sketch.width(), $sketch.height(), 0.5, function() {
            $sketch.empty();
            julia.rootView.draw($sketch);
            julia.dumpAlternativesAsSnap($sketches, $sketch.width(), $sketch.height(), 0.5);
        });
    }

};
var p_key_hook = new PKeyEventHook(document);
var p_cap_key_hook = new PCapKeyEventHook(document);
julia.addEventSource(p_key_hook);
var mHook = new PMouseEventHook($sketch[0]);

mHook.variance_x_px = 1;
mHook.variance_y_px = 1;
julia.addEventSource(mHook);
julia.addEventSource(makeVoiceEventSource());
reset();
$("#start_speech").click(function(){
    source.start();
});
$("#stop_speech").click(function(){
    source.stop();
});

</script>


</body>
</html>