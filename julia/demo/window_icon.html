<!-- Created on 5/26/2014 -->
<!DOCTYPE html>
<html>
<head>
    <title>Resizeable Window & Draggable Icon</title>

    <!-- JQuery -->
    <script type="text/javascript" src="../lib/jquery.js"></script>

    <!-- Snap SVG library -->
    <script type="text/javascript" src="../lib/snap.svg.js"></script>

    <!-- Julia library -->
    <script type="text/javascript" src="../julia.js"></script>

    <!-- Julia CSS -->
    <link type="text/css" rel="stylesheet" href="../julia.css"/>

    <!-- Draggable/Resizeable -->
    <script type="text/javascript" src="../views/draggable_resizeable_box.js"></script>

    <style>

        body{
            overflow:hidden
        }
        td {
            vertical-align: top;
        }
    </style>
</head>
<body>
<h3>Resizeable Window and Draggable Icon</h3>
<div id="top_bar"></div>
<div id="demo_description">
    Try resizing the window horizontally, vertically. Move perpendicularly to 'snap out'.
    Then try moving the icons underneath.</div>
<div id="demo_settings"></div>

<table>
    <tr>
        <td><svg id="main_interface" class="demo-interface" width="640" height="640" style="cursor:none"></svg></td>
        <td><div id="alternatives" class="demo-alternatives"></div></td>
    </tr>
</table>


<table id="interactor_tree_table">
    <tr>
        <td>Interactor tree of main interface:</td>
    </tr>
    <tr>
        <td><div id="interactor_tree_div"/></td>
    </tr>
</table>

<script>
    // Your custom views here
    var Window = DraggableResizeableBox2.subClass( {
        className: "Window",
        hit_test: function(e, transition) {
            var coords = this.get_relative(e);
            if(transition.to === "dragging") {
                return (coords.rx > 0 && coords.ry > 0 && coords.rx < this.properties.w && coords.ry < 2 * this.properties.resize_padding);
            }
            return this._super(e, transition);
        },
        draw: function ($el) {
            // in this case $el will be an SVG element
            var s = Snap($el[0]);
            var padding = 5;
            var border_attrs = {fill: "white", "stroke-width": 1, stroke: "black"};
            if(this.current_state === "dragging") {
                s.rect(this.properties.x - padding, this.properties.y - padding, this.properties.w + 2 * padding, this.properties.h + 2 * padding)
                        .attr(border_attrs);
            } else if (this.current_state === "resize_left") {
                s.rect(this.properties.x - padding, this.properties.y - padding, 2 * padding, this.properties.h + 2 * padding)
                        .attr(border_attrs);
            } else if (this.current_state === "resize_right") {
                s.rect(this.properties.x + this.properties.w - padding, this.properties.y - padding, 2 * padding, this.properties.h + 2 * padding)
                        .attr(border_attrs);
            } else if (this.current_state === "resize_top") {
                s.rect(this.properties.x - padding, this.properties.y - padding, this.properties.w + 2 * padding, 2 * padding)
                        .attr(border_attrs);
            } else if (this.current_state === "resize_bottom") {
                s.rect(this.properties.x - padding, this.properties.y + this.properties.h - padding, this.properties.w + 2 * padding, 2 * padding)
                        .attr(border_attrs);
            }
            s.rect(this.properties.x, this.properties.y, this.properties.w, this.properties.h).attr({fill: "#ffdddd"});
            s.rect(this.properties.x, this.properties.y, this.properties.w, 2 * this.properties.resize_padding).attr({fill: "#CCCCCC"});

            var y0 = this.properties.y + 10 + 3 * this.properties.resize_padding;
            var x0 = this.properties.x + 10

            var pd2 = 5;
            x0 = this.properties.x + 2 * pd2;
            y0 = this.properties.y + 2 * pd2;
            var dx = 3 * pd2;
            var colors = ["#E33037", "#FBF536","#7DC04A"];
            colors.forEach(function(c, i){
                s.circle(x0 + i * dx, y0, pd2).attr({fill: c});
            });

        },
    }
    );

    var Icon = DraggableBox.subClass({
        className: "Icon",
        draw: function ($el) {
            // in this case $el will be an SVG element
            var s = Snap($el[0]);
            var regular = "#8dcbfc";
            var dark = "#6fa0c7";
            var color = regular;
            if(this.current_state == "dragging") {
                color = dark;
            }
            s.rect(this.properties.x, this.properties.y, 40, 30).attr({fill: color, rx: 5, ry: 5});
            s.rect(this.properties.x, this.properties.y + 10, this.properties.w, this.properties.h - 10).attr({fill: color, rx: 3, ry:3});
        }
    });
</script>
<script>

    /**
     * Set up the interface here
     * @param rootView
     */
    function setup(julia, rootView) {
        rootView.addChildView(new Icon(julia, {x: 234, y: 205, w: 110, h: 90}));
        rootView.addChildView(new Icon(julia, {x: 464, y: 231, w: 110, h: 90}));
        rootView.addChildView(new Icon(julia, {x: 269, y: 364, w: 110, h: 90}));
        rootView.addChildView(new Icon(julia, {x: 404, y: 428, w: 110, h: 90}));
        rootView.addChildView(new Window(julia, {x: 25, y: 20, w: 268, h: 228, resize_padding: 10}));
        rootView.addChildView(new Window(julia, {x: 333, y: 19, w: 268, h:228, resize_padding: 10}));
        rootView.addChildView(new Window(julia, {x: 31, y: 333, w: 268, h: 228, resize_paddding: 10}));
    }


    var mouseX = 0;
    var mouseY = 0;
    var variance = 0;
    /**
     * Executed when the document loads. Intended to be boilerplate, shouldn't have to replace much here (for now).
     */
    $(document).ready(function(){
        var julia = new Julia();
        var rootView = new ContainerView(julia, {background_color: "#333333"});
        julia.setRootView(rootView);

        // Initialize feedback
        julia.feedback = new OverlayFeedback(julia,
                {feedbackType:  FeedbackOpacityGrayScaleAmbiguousView,
                    renderThreshold: 0.01});

        setup(julia, rootView);

        var $alternatives = $("#alternatives");
        var $mainInterface = $("#main_interface");
        // Add an event source
        var mouseHook = new PMouseEventHook($mainInterface[0], 10, 10);
        var touchHook = new PTouchEventHook($mainInterface[0], 10, 10);

        mouseHook.addListener(function(e) {
            mouseX = e.element_x;
            mouseY = e.element_y;
            variance = e.sigma_x;
        });
        touchHook.addListener(function(e) {
            mouseX = e.element_x;
            mouseY = e.element_y;
            variance = e.sigma_x;
        });

        julia.addEventSource(mouseHook);
        julia.addEventSource(touchHook);

        julia.drawFeedback($mainInterface, julia.feedback);

        julia.dispatchCompleted = function(new_alternatives, uiUpdated) {
            var s = Snap($mainInterface[0]);
            $mainInterface.empty();
            julia.drawFeedback($mainInterface, julia.feedback);

            s.circle(mouseX, mouseY, 2 * variance).attr({fill: "#D636FB"});
            julia.dumpAlternativesAsSnap($alternatives, $mainInterface.width(), $mainInterface.height(), 0.5);
        };

        $("#interactor_tree_table").hide();
    });
</script>
</body>
</html>